<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <title>Upload Image - Task Creation</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background-color: #f8f9fa;
        }

        .container {
            text-align: center;
            padding: 30px;
            background: #fff;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .btn-submit {
            margin-top: 20px;
        }

        .loading-spinner {
            display: none;
            justify-content: center;
            align-items: center;
            margin-top: 20px;
        }

        .loading-spinner .spinner-border {
            width: 3rem;
            height: 3rem;
        }
    </style>
</head>
<body>
<div class="container">
    <h1>Upload Image to Create Task</h1>
    <form id="uploadForm">
        <div class="mb-3">
            <label class="form-label" for="imageInput">Select Image</label>
            <input accept="image/*" class="form-control" id="imageInput" name="image" required type="file">
        </div>
        <button class="btn btn-primary btn-submit" type="submit">Submit</button>
    </form>
    <div class="loading-spinner" id="loadingSpinner">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>
    <div class="mt-3" id="responseMessage"></div>
</div>

<script>
    const POLLING_INTERVAL = 3000; // Poll every 3 seconds

    document.getElementById("uploadForm").addEventListener("submit", async function (event) {
        event.preventDefault(); // Prevent default form submission behavior

        const fileInput = document.getElementById("imageInput");
        const file = fileInput.files[0];

        if (!file) {
            alert("Please select an image.");
            return;
        }

        const loadingSpinner = document.getElementById("loadingSpinner");
        const responseMessage = document.getElementById("responseMessage");

        try {
            // Show the loading spinner
            loadingSpinner.style.display = "flex";

            // Step 1: Upload the image to the storage service
            const storageResponse = await fetch("/storage", {
                method: "POST",
                body: file
            });

            if (storageResponse.ok) {
                const storageFileId = await storageResponse.text();

                // Step 2: Use the storage file ID to create a tasks
                const taskRequestBody = JSON.stringify({image: storageFileId});
                const taskResponse = await fetch("/tasks", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: taskRequestBody
                });

                if (taskResponse.ok) {
                    const taskData = await taskResponse.json();
                    responseMessage.innerHTML = `<div class="alert alert-info">Task created successfully! Task ID: ${taskData.id}. Polling for results...</div>`;

                    // Start polling for the tasks result
                    pollForResult(taskData.id);
                } else {
                    const taskError = await taskResponse.json();
                    responseMessage.innerHTML = `<div class="alert alert-danger">Error: ${taskError.message || "Failed to create task."}</div>`;
                }
            } else {
                responseMessage.innerHTML = `<div class="alert alert-danger">Error: Failed to upload image to storage.</div>`;
            }

            // Hide the spinner after finishing the process
            loadingSpinner.style.display = "none";

        } catch (error) {
            console.error("Error:", error);
            responseMessage.innerHTML = `<div class="alert alert-danger">Error: Unable to complete the process.</div>`;
            loadingSpinner.style.display = "none";
        }
    });

    async function pollForResult(taskId) {
        const loadingSpinner = document.getElementById("loadingSpinner");
        const responseMessage = document.getElementById("responseMessage");

        const interval = setInterval(async () => {
            try {
                console.log("Polling for task result...");
                const response = await fetch(`/tasks/${taskId}`);
                if (response.ok) {
                    const data = await response.json();
                    if (data.status === "IN_PROGRESS") {
                        console.log("Task is still in progress...");
                    } else if (data.status === "COMPLETED") {
                        console.log("Task completed:", data);
                        clearInterval(interval); // Stop polling
                        loadingSpinner.style.display = "none"; // Hide spinner

                        // Show success message and alert
                        responseMessage.innerHTML = `<div class="alert alert-success">Task completed!</div>`;
                        alert("COMPLETED");
                    } else {
                        console.log("Task failed or unknown status:", data);
                    }
                }
            } catch (error) {
                console.error("Polling error:", error);
            }
        }, POLLING_INTERVAL);
    }
</script>
</body>
</html>
